<div class="outgoing correspondence js-collapsable collapsed" id="outgoing-<%=outgoing_message.id.to_s%>">
  <%- if cannot?(:read, outgoing_message) %>
    <%= render :partial => 'request/hidden_correspondence', :locals => { :message => outgoing_message } %>
  <%- else %>
    <%= render :partial => 'request/restricted_correspondence', :locals => {:message => outgoing_message } %>
    <% delivery_status = outgoing_message.delivery_status %>

    <div class="correspondence__header <% if delivery_status %>correspondence__header--with-delivery-status<% end %>">
      <span class="correspondence__header__author js-collapsable-trigger">
        <% if outgoing_message.message_type == 'initial_request' %>
          <%= _('Resent request from {{request_sent_date}} to {{public_body_link}}',
                request_sent_date: (simple_date(outgoing_message.created_at)),
                public_body_link: (public_body_link(@info_request.public_body))) %>
        <% elsif outgoing_message.message_type == 'followup' %>
          <%= _('Resent a follow up from {{request_sent_date}} to {{public_body_link}}',
                request_sent_date: (simple_date(outgoing_message.created_at)),
                public_body_link: (public_body_link(@info_request.public_body))) %>
        <% else %>
        <%= _('Resent {{unknown_message_type}} from {{request_sent_date}} to {{public_body_link}}',
              request_sent_date: (simple_date(outgoing_message.created_at)),
              public_body_link: (public_body_link(@info_request.public_body)),
              unknown_message_type: (raise "unknown message_type")) %>
        <% end %>
        <% if not info_request_event.same_email_as_previous_send? %><%= _('using a new contact address') %><% end %>
      </span>

      <%= link_to outgoing_message_path(outgoing_message), :class => 'correspondence__header__date' do %>
          <%= simple_date(info_request_event.created_at) %>
      <% end %>
      <% if delivery_status %>
        <div class="correspondence__header__delivery-status">
          <%= link_to outgoing_message_delivery_status_path(outgoing_message), :class => "toggle-delivery-log toggle-delivery-log--#{outgoing_message.delivery_status.simple} js-toggle-delivery-log", :'data-delivery-status' => outgoing_message.delivery_status.simple do -%>
            <%= outgoing_message.delivery_status.simple.to_s.humanize -%>
          <% end -%>
        </div>
      <% end %>
    </div>

    <div class="js-delivery-log-ajax-error" hidden aria-hidden="true" style="display: none; visibility: hidden;">
      <p><%= _('We couldnâ€™t load the mail server logs for this message.') %></p>
      <p><%= link_to _('Try opening the logs in a new window.'), outgoing_message_delivery_status_path(outgoing_message), :target => '_blank' %></p>
    </div>

    <%= render :partial => 'request/bubble', :locals => { :body => outgoing_message.get_body_for_html_display(), :attachments => nil }  %>

    <p class="event_actions">
      <% if outgoing_message.status == 'ready' && !@info_request.is_external? %>
        <%= _('<strong>Warning:</strong> This message has <strong>not yet ' \
                 'been sent</strong> for an unknown reason.') %>
      <% end %>
  <%- end %>
</div>
